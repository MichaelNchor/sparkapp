<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spark ‚Äì Email Verification</title>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        text-align: center;
      }

      .container {
        max-width: 500px;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(8px);
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      p {
        font-size: 1.1rem;
        margin-bottom: 2rem;
      }

      a.button {
        display: inline-block;
        padding: 0.8rem 2rem;
        font-size: 1rem;
        font-weight: bold;
        text-decoration: none;
        color: #ff416c;
        background: white;
        border-radius: 30px;
        transition: all 0.3s ease;
        margin: 0.5rem;
      }

      a.button:hover {
        background: #ffe0e7;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 1rem auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      .debug-info {
        background: rgba(0, 0, 0, 0.3);
        padding: 1rem;
        border-radius: 10px;
        margin: 1rem 0;
        font-family: monospace;
        font-size: 0.8rem;
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>‚ú® Spark</h1>

      <!-- Debug Info -->
      <div class="debug-info">
        <strong>üîç URL Debug Info:</strong><br>
        <div id="debug-content">Loading...</div>
      </div>

      <!-- Loading State -->
      <div id="loading-state">
        <div class="spinner"></div>
        <p>Verifying your email...</p>
      </div>

      <!-- Success State -->
      <div id="success-state" class="hidden">
        <h2>üéâ Email Verified!</h2>
        <p>Opening the Spark app...</p>
        <a href="#" id="open-app-btn" class="button">Open Spark App</a>
        <a href="#" id="open-intent-btn" class="button">Try Intent Method</a>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden">
        <h2>‚ö†Ô∏è Verification Issue</h2>
        <p id="error-message">There was an issue with your verification link.</p>
        <a href="/" class="button">Go to Spark</a>
        <a href="#" id="retry-btn" class="button">Try Again</a>
      </div>

      <footer style="margin-top: 2rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">
        &copy; 2025 Spark Dating App. All rights reserved.
      </footer>
    </div>

    <script>
      function showState(stateId) {
        document
          .querySelectorAll('[id$="-state"]')
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(stateId).classList.remove("hidden");
      }

      function getUrlParams() {
        const params = new URLSearchParams();

        // Method 1: Get search parameters (?param=value)
        const searchParams = new URLSearchParams(window.location.search);
        searchParams.forEach((value, key) => params.set(key, value));

        // Method 2: Get hash parameters (#param=value) - Supabase often uses hash
        if (window.location.hash) {
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          hashParams.forEach((value, key) => params.set(key, value));
        }

        // Method 3: Manual parsing for malformed URLs (fallback)
        const url = window.location.href;
        
        // Check if there are parameters that might be malformed
        if (url.includes('access_token=') && !params.has('access_token')) {
          console.log('üîß Attempting manual parameter extraction...');
          
          // Extract everything after the first '?' or '#'
          const paramString = url.split(/[?#]/)[1] || '';
          
          if (paramString) {
            // Split by & and manually parse each parameter
            const pairs = paramString.split('&');
            pairs.forEach(pair => {
              const [key, value] = pair.split('=');
              if (key && value) {
                try {
                  params.set(decodeURIComponent(key), decodeURIComponent(value));
                } catch (e) {
                  // If decoding fails, use raw values
                  params.set(key, value);
                }
              }
            });
          }
        }

        return params;
      }

      function updateDebugInfo() {
        const params = getUrlParams();
        const debugContent = document.getElementById('debug-content');
        
        // Parse URL components manually for debugging
        const url = window.location.href;
        const urlParts = {
          'Full URL': url,
          'Search': window.location.search || 'None',
          'Hash': window.location.hash || 'None',
          'Contains access_token': url.includes('access_token'),
          'Contains &': url.includes('&'),
          'Parameter count': params.size,
          'Is Android': /Android/i.test(navigator.userAgent)
        };

        let debugHtml = '';
        for (const [key, value] of Object.entries(urlParts)) {
          debugHtml += `<strong>${key}:</strong> ${value}<br>`;
        }

        debugHtml += '<br><strong>Extracted Parameters:</strong><br>';
        if (params.size === 0) {
          debugHtml += '<span style="color: #ff6b6b;">‚ùå No parameters found!</span><br>';
        } else {
          for (const [key, value] of params.entries()) {
            const shortValue = value.length > 30 ? value.substring(0, 30) + '...' : value;
            debugHtml += `&nbsp;&nbsp;${key}: ${shortValue}<br>`;
          }
        }
        
        debugContent.innerHTML = debugHtml;
      }

      function redirectToApp(params) {
        console.log('üöÄ Starting app redirect...');
        console.log('üìã Parameters:', Object.fromEntries(params));

        // Create properly encoded URLs
        const encodedParams = new URLSearchParams();
        params.forEach((value, key) => {
          encodedParams.set(key, value);
        });

        const appUrl = `sparkapp://auth/verify?${encodedParams.toString()}`;
        const intentUrl = `intent://auth/verify?${encodedParams.toString()}#Intent;scheme=sparkapp;package=spark.dating.app.android;S.browser_fallback_url=${encodeURIComponent('https://sparkapp.dev')};end`;

        console.log('üîó App URL:', appUrl);
        console.log('üîó Intent URL:', intentUrl);

        // Set button hrefs
        document.getElementById("open-app-btn").href = appUrl;
        document.getElementById("open-intent-btn").href = intentUrl;
        if (document.getElementById("retry-btn")) {
          document.getElementById("retry-btn").href = appUrl;
        }

        if (/Android/i.test(navigator.userAgent)) {
          console.log('ü§ñ Android - using intent method first');
          
          // Method 1: Intent URL (most reliable)
          setTimeout(() => {
            console.log('üì± Trying intent URL...');
            window.location.href = intentUrl;
          }, 1000);

          // Method 2: Direct scheme fallback
          setTimeout(() => {
            console.log('üì± Trying direct scheme...');
            window.location.href = appUrl;
          }, 3000);

        } else {
          console.log('üçé iOS/Other - using direct scheme');
          setTimeout(() => {
            window.location.href = appUrl;
          }, 1000);
        }
      }

      function handleVerification() {
        const params = getUrlParams();

        console.log('üîç Starting verification...');
        console.log('üìÑ URL:', window.location.href);
        console.log('üìã Params:', Object.fromEntries(params));

        const accessToken = params.get("access_token") || params.get("token");
        const refreshToken = params.get("refresh_token");
        const error = params.get("error");
        const errorDescription = params.get("error_description");

        console.log('üîë Tokens found:', {
          accessToken: !!accessToken,
          refreshToken: !!refreshToken,
          error: error
        });

        if (error) {
          console.error('‚ùå Auth error:', error, errorDescription);
          
          let errorMessage = "There was an error with your verification.";
          if (error === "access_denied") {
            errorMessage = "Email verification was denied or cancelled.";
          } else if (errorDescription?.includes("expired")) {
            errorMessage = "Your verification link has expired. Please request a new one.";
          } else if (errorDescription) {
            errorMessage = errorDescription;
          }

          document.getElementById("error-message").textContent = errorMessage;
          showState("error-state");

          // Still try to redirect with error info
          setTimeout(() => redirectToApp(params), 2000);
          
        } else if (accessToken) {
          console.log('‚úÖ Success! Redirecting to app...');
          showState("success-state");
          setTimeout(() => redirectToApp(params), 1500);
          
        } else {
          console.warn('‚ö†Ô∏è No valid tokens found');
          document.getElementById("error-message").textContent =
            "This verification link appears to be invalid. No authentication tokens found.";
          showState("error-state");
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        console.log('üìÑ Page loaded');
        
        updateDebugInfo();

        // Add click handlers
        document.getElementById("open-app-btn").addEventListener("click", function (e) {
          e.preventDefault();
          console.log('üîÑ Manual app button clicked');
          const params = getUrlParams();
          redirectToApp(params);
        });

        document.getElementById("open-intent-btn").addEventListener("click", function (e) {
          e.preventDefault();
          console.log('üîÑ Manual intent button clicked');
          const params = getUrlParams();
          const encodedParams = new URLSearchParams();
          params.forEach((value, key) => encodedParams.set(key, value));
          const intentUrl = `intent://auth/verify?${encodedParams.toString()}#Intent;scheme=sparkapp;package=spark.dating.app.android;end`;
          window.location.href = intentUrl;
        });

        const retryBtn = document.getElementById("retry-btn");
        if (retryBtn) {
          retryBtn.addEventListener("click", function (e) {
            e.preventDefault();
            console.log('üîÑ Retry clicked');
            const params = getUrlParams();
            redirectToApp(params);
          });
        }

        // Start verification process
        setTimeout(handleVerification, 1000);
      });

      // Handle page visibility
      document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
          console.log('üì± Page hidden - app likely opened');
        } else {
          console.log('üëÄ Page visible - app might not have opened');
        }
      });
    </script>
  </body>
</html>