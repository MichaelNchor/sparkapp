<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spark ‚Äì Email Verification</title>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #ff416c, #ff4b2b);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        text-align: center;
      }

      .container {
        max-width: 500px;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(8px);
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      p {
        font-size: 1.1rem;
        margin-bottom: 2rem;
      }

      a.button {
        display: inline-block;
        padding: 0.8rem 2rem;
        font-size: 1rem;
        font-weight: bold;
        text-decoration: none;
        color: #ff416c;
        background: white;
        border-radius: 30px;
        transition: all 0.3s ease;
        margin: 0.5rem;
      }

      a.button:hover {
        background: #ffe0e7;
      }

      .loading {
        color: #fff;
      }

      .success {
        color: #28a745;
      }

      .error {
        color: #ffc107;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 1rem auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      footer {
        margin-top: 2rem;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
      }

      .hidden {
        display: none;
      }

      .debug-info {
        background: rgba(0, 0, 0, 0.3);
        padding: 1rem;
        border-radius: 10px;
        margin: 1rem 0;
        font-family: monospace;
        font-size: 0.8rem;
        text-align: left;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>‚ú® Spark</h1>

      <!-- Debug Info (for troubleshooting) -->
      <div class="debug-info">
        <strong>üîç Debug Info:</strong><br>
        <div id="debug-content">Loading...</div>
      </div>

      <!-- Loading State -->
      <div id="loading-state">
        <div class="spinner"></div>
        <p>Verifying your email...</p>
      </div>

      <!-- Success State -->
      <div id="success-state" class="hidden">
        <h2>üéâ Email Verified!</h2>
        <p>
          Your email has been successfully verified. Opening the Spark app...
        </p>
        <a href="#" id="open-app-btn" class="button">Open Spark App</a>
        <a href="#" id="open-intent-btn" class="button">Try Intent Method</a>
        <p style="font-size: 0.9rem; margin-top: 1rem">
          If the app doesn't open automatically, tap the buttons above.
        </p>
        <div id="app-link-info" style="margin-top: 1rem; font-size: 0.8rem;"></div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden">
        <h2>‚ö†Ô∏è Verification Issue</h2>
        <p id="error-message">
          There was an issue with your verification link.
        </p>
        <a href="/" class="button">Go to Spark</a>
        <a href="#" id="retry-btn" class="button">Try Again</a>
      </div>

      <footer>&copy; 2025 Spark Dating App. All rights reserved.</footer>
    </div>

    <script>
      // Utility functions
      function showState(stateId) {
        document
          .querySelectorAll('[id$="-state"]')
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(stateId).classList.remove("hidden");
      }

      function getUrlParams() {
        const params = new URLSearchParams();

        // Get search parameters (?param=value)
        const searchParams = new URLSearchParams(window.location.search);
        searchParams.forEach((value, key) => params.set(key, value));

        // Get hash parameters (#param=value) - Supabase often uses hash
        if (window.location.hash) {
          const hashParams = new URLSearchParams(
            window.location.hash.substring(1)
          );
          hashParams.forEach((value, key) => params.set(key, value));
        }

        return params;
      }

      function updateDebugInfo() {
        const params = getUrlParams();
        const debugContent = document.getElementById('debug-content');
        
        const debugInfo = {
          'Full URL': window.location.href,
          'Search': window.location.search || 'None',
          'Hash': window.location.hash || 'None',
          'User Agent': navigator.userAgent.substring(0, 60) + '...',
          'Is Android': /Android/i.test(navigator.userAgent),
          'Parameters': Object.fromEntries(params),
          'Has Access Token': params.has('access_token') || params.has('token'),
          'Has Refresh Token': params.has('refresh_token')
        };

        let debugHtml = '';
        for (const [key, value] of Object.entries(debugInfo)) {
          debugHtml += `<strong>${key}:</strong> ${JSON.stringify(value)}<br>`;
        }
        
        debugContent.innerHTML = debugHtml;
      }

      function redirectToApp(params) {
        console.log('üöÄ Starting app redirect process...');
        console.log('üìã Raw parameters:', Object.fromEntries(params));

        // Create properly encoded URLs using URLSearchParams for safety
        const encodedParams = new URLSearchParams();
        params.forEach((value, key) => {
          encodedParams.set(key, value);
        });

        const appUrl = `sparkapp://auth/verify?${encodedParams.toString()}`;
        const intentUrl = `intent://auth/verify?${encodedParams.toString()}#Intent;scheme=sparkapp;package=spark.dating.app.android;S.browser_fallback_url=${encodeURIComponent('https://sparkapp.dev')};end`;

        console.log('üîó App URL:', appUrl);
        console.log('üîó Intent URL:', intentUrl);

        // Update UI with link info
        const linkInfo = document.getElementById('app-link-info');
        if (linkInfo) {
          linkInfo.innerHTML = `
            <strong>App Link:</strong><br>
            <code style="background: rgba(0,0,0,0.3); padding: 0.2rem; border-radius: 3px; word-break: break-all; font-size: 0.7rem;">${appUrl}</code>
          `;
        }

        // Set button hrefs
        document.getElementById("open-app-btn").href = appUrl;
        document.getElementById("open-intent-btn").href = intentUrl;
        if (document.getElementById("retry-btn")) {
          document.getElementById("retry-btn").href = appUrl;
        }

        if (/Android/i.test(navigator.userAgent)) {
          console.log('ü§ñ Android detected - using enhanced redirect methods');
          
          // Method 1: Intent URL (most reliable for Android with complex tokens)
          setTimeout(() => {
            console.log('üì± Method 1: Intent URL');
            window.location.href = intentUrl;
          }, 1000);

          // Method 2: Direct scheme (fallback)
          setTimeout(() => {
            console.log('üì± Method 2: Direct scheme fallback');
            window.location.href = appUrl;
          }, 3000);

          // Method 3: Hidden iframe method (additional fallback)
          setTimeout(() => {
            console.log('üì± Method 3: iframe method');
            try {
              const iframe = document.createElement('iframe');
              iframe.style.display = 'none';
              iframe.src = appUrl;
              document.body.appendChild(iframe);
              setTimeout(() => {
                if (document.body.contains(iframe)) {
                  document.body.removeChild(iframe);
                }
              }, 2000);
            } catch (e) {
              console.log('Iframe method failed:', e);
            }
          }, 5000);

        } else {
          console.log('üçé iOS/Other platform - using direct scheme');
          setTimeout(() => {
            window.location.href = appUrl;
          }, 1000);
        }
      }

      function handleVerification() {
        const params = getUrlParams();

        console.log('üîç Starting verification process...');
        console.log('üìÑ Current URL:', window.location.href);
        console.log('üîé Search params:', window.location.search);
        console.log('üîó Hash params:', window.location.hash);
        console.log('üìã Extracted params:', Object.fromEntries(params));

        // Check for authentication tokens
        const accessToken = params.get("access_token") || params.get("token");
        const refreshToken = params.get("refresh_token");
        const error = params.get("error");
        const errorDescription = params.get("error_description");

        console.log('üîë Token analysis:', {
          hasAccessToken: !!accessToken,
          accessTokenLength: accessToken ? accessToken.length : 0,
          hasRefreshToken: !!refreshToken,
          refreshTokenLength: refreshToken ? refreshToken.length : 0,
          error,
          errorDescription
        });

        if (error) {
          // Handle authentication errors
          console.error('‚ùå Auth error:', error, errorDescription);

          let errorMessage = "There was an error with your verification.";

          if (error === "access_denied") {
            errorMessage = "Email verification was denied or cancelled.";
          } else if (errorDescription?.includes("expired")) {
            errorMessage =
              "Your verification link has expired. Please request a new one.";
          } else if (errorDescription) {
            errorMessage = errorDescription;
          }

          document.getElementById("error-message").textContent = errorMessage;
          showState("error-state");

          // Still try to redirect to app with error info
          setTimeout(() => redirectToApp(params), 2000);
          
        } else if (accessToken) {
          // Success - we have tokens
          console.log('‚úÖ Verification successful, redirecting to app...');
          showState("success-state");

          // Redirect to app after short delay
          setTimeout(() => redirectToApp(params), 1500);
          
        } else {
          // No relevant parameters found
          console.warn('‚ö†Ô∏è No auth parameters found in URL');
          document.getElementById("error-message").textContent =
            "This verification link appears to be invalid or incomplete. No authentication tokens found.";
          showState("error-state");
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", function () {
        console.log('üìÑ Page loaded, initializing...');

        // Update debug info immediately
        updateDebugInfo();

        // Add click handlers
        document
          .getElementById("open-app-btn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            console.log('üîÑ Manual app open button clicked');
            const params = getUrlParams();
            redirectToApp(params);
          });

        document
          .getElementById("open-intent-btn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            console.log('üîÑ Manual intent button clicked');
            const params = getUrlParams();
            const encodedParams = new URLSearchParams();
            params.forEach((value, key) => {
              encodedParams.set(key, value);
            });
            const intentUrl = `intent://auth/verify?${encodedParams.toString()}#Intent;scheme=sparkapp;package=spark.dating.app.android;end`;
            window.location.href = intentUrl;
          });

        const retryBtn = document.getElementById("retry-btn");
        if (retryBtn) {
          retryBtn.addEventListener("click", function (e) {
            e.preventDefault();
            console.log('üîÑ Retry button clicked');
            const params = getUrlParams();
            redirectToApp(params);
          });
        }

        // Start verification process after a brief delay
        setTimeout(handleVerification, 1000);
      });

      // Handle page visibility changes (useful for mobile)
      document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
          console.log('üì± Page hidden - app likely opened successfully');
        } else {
          console.log('üëÄ Page visible again - app might not have opened');
        }
      });

      // Handle window focus changes
      window.addEventListener('blur', function() {
        console.log('üîÑ Window lost focus - app might have opened');
      });

      window.addEventListener('focus', function() {
        console.log('üîÑ Window gained focus - user returned to browser');
      });
    </script>
  </body>
</html>